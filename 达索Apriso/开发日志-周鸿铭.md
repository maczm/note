[TOC]

# 开发日志

蓝色模块----外部链接地址项

### 2、序列化与反序列化

在Apriso中，在function之间，对象与对象之间的传递都是**字符串类型**的，如果要多传过来的值进行内部对象值的操作，那么就要进行**反序列化**，才能通过【对象.属性】的方式，取得属性的值

然后再**序列化**将对象传出去

```java
//反序列化json
dynamic newObj = JsonConvert.DeserializeObject(JsonObject);
//获取reported数组
Newtonsoft.Json.Linq.JArray reportedList = newObj.reported;
ObjectList = new string [reportedList.Count()];
if(reportedList!=null){
	for(var i = 0;i<reportedList.Count();i++){
		//序列化子json
	    ObjectList[i]= Newtonsoft.Json.JsonConvert.SerializeObject(
			new {
				//协议版本
				version = newObj.version,
				//任务ID
				taskId = newObj.taskId,
				//任务类型
				taskType = newObj.taskType,
				//子reported
				reported = newObj.reported[i]
			}
	 	);
	}
}
```

```java
//使用JS序列化Json
var Date = {
		Inputs : {
			Json : {
				ProductDetail:[]
			}
		}
}
var arr = new Array();
for(var i = 0;i<iFacility.length;i++){
	var json = {
				//工厂ID
				Facility:iFacility[i],
				//物料编码
				ProductNo:iProductNo[i],
				//序列号或车号
				SerialNo:iSerialNo[i],
				//检验结果
				CheckResult:iCheckResult[i],
				//检验时间
				CheckTime:iCheckTime[i]
			}
	arr.push(json);
}


Date.Inputs.Json.ProductDetail = arr;
JsonObject = jsonstringify(Date);


//object格式序列化为string
function jsonstringify(obj){
　　var type = typeof obj;
　　if(type !== 'object'){
　　　　if(/string|undefined|function/.test(type)){
　　　　　　obj = '"' + obj +'"'
　　　　}
　　　　return String(obj)
　　}else{
　　　　var arr = isArrayFn(obj);
　　　　var json =[];
　　　　for(var i in obj){
　　　　　　var j = obj[i];
　　　　　　var type = typeof j
　　　　　　if(/string|undefined|function/.test(type)){
　　　　　　　　j = '"' + j +'"'
　　　　　　}else if(type == 'object'){
　　　　　　　　j = jsonstringify(j)
　　　　　　}
　　　　　　json.push((arr ? "" : '"' + i + '":') + String(j));
　　　　}
　　　　return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}")
　　}
}

function isArrayFn (o) {
	return Object.prototype.toString.call(o) === '[object Array]';
}
```



### 3、反序列化后对象属性值为数组

```java
dynamic json = JsonConvert.DeserializeObject(JsonObject);//此时的json为object类型，没有特定的类型，如果需要进行明确值的比较时，需要将类型进行转化例如：
//if（"1".equals(json.code)）--这种是比较不了的，因为（json.code）是object类型，"1"是string类型的，所以需要通过string codetype = json.code,然后if（"1".equals(json.code)）此时才会进入判断
//反序列化json
dynamic newObj = JsonConvert.DeserializeObject(JsonObject);

//在JsonObject的属性值为数组时，需要将对象定义为对象数组，不能直接进行循环
Newtonsoft.Json.Ling.JArray  DeliverList = json.DELIVER
    
//然后再对该数组中的属性，进行数组的声明
OrderLineNo = new int[DeliverList.Count()];
ProductID = new string[DeliverList.Count()];
ClosedDate = new DateTime[DeliverList.Count()];
QuantityOrdered = new decimal[DeliverList.Count()];
SerialNumber = new string[DeliverList.Count()];

for(var i = 0; i<DeliverList.Count(); i++){
    str  =json.DELIVERDETAIL[i].POSNR;
    int.TryParse(str,out a);
    //出货单行号
    OrderLineNo[i] = a;
    //车号（序列号）
    SerialNumber[i] = json.DELIVERDETAIL[i].SERNR;
    //成品编码
    ProductID[i] = json.DELIVERDETAIL[i].MATNR;
    //String to DateTime
    string tempDate = json.DELIVERDETAIL[i].WADAT;
    time = tempDate.Substring(0,4)+"-"+tempDate.Substring(4,2)+""+tempDate.Substring(6,2) + " 00:00:00";
    //交货日期
    ClosedDate[i] = Convert.ToDateTime(time);
    //发货数量
    QuantityOrdered[i] = json.DELIVERDETAIL[i].LFIMG;
}
```

```java
{
    "version": 1,
    "taskId": "7c3e01a0d11840479ade4db74aa9576a",
    "taskType": 36,
    "task": {
        "Facility": "5802",
        "ProductionLine": "5802HJ03",
        "WorkCenter": "123456",
        "planList": [
            {
                "packDataVersion": "1",
                "planNo": "78946",
                "orderList": [
                    {
                        "WIPOrderNo": "860000040813",
                        "attribute": "",
                        "paramRsrv3": "ZQ-370C8-40813-2012",
                        "paramRsrv4": ""
                    }
                ]
            }
        ]
    }
}

//反序列化Json对象
dynamic newobj = JsonConvert.DeserializeObject(Json);
//获取planList数组对象
Newtonsoft.Json.Linq.JArray planList = newobj.task.planList;
//初始化planNo数组对象
planNo = new string[planList.Count()];
//遍历planList数组对象
for(var i =0;i<planList.Count();i++)
{
	//获取数组中每个planNo的值
	planNo[i] = newobj.task.planList[i].planNo;
	//获取在planList数组对象下的orderList数组对象
	Newtonsoft.Json.Linq.JArray orderList = newobj.task.planList[i].orderList;
	//初始化orderList数组对象下的对象数组
	WIPOrderNo = new string[orderList.Count()];
	//遍历orderList数组对象
	for(var j = 0;j<orderList.Count();j++)
	{
		//获取该数组对象下每个WIPOrderNo的值
		WIPOrderNo[j] = newobj.task.planList[i].orderList[j].WIPOrderNo;
	}
}
```

```java
//新方式解析Json传
/反序列化父JSON
Newtonsoft.Json.Linq.JObject jsonProductMaster = Newtonsoft.Json.JsonConvert.DeserializeObject<Newtonsoft.Json.Linq.JObject>(JsonObject);


/********************************物料主数据接口数据 ***********************************/


//物料编号
if (jsonProductMaster["MATNR"] != null){
	MATNR = jsonProductMaster["MATNR"].ToString();
}
else{
	MATNR = "";
}

/********************************各数组赋值 ***********************************/
if(jsonProductMaster["MAKT"] != null)
{
	//序列化子JSON-反序列化子JSON
	string MAKT = Newtonsoft.Json.JsonConvert.SerializeObject(jsonProductMaster["MAKT"]);
	Newtonsoft.Json.Linq.JArray jsonMAKT = Newtonsoft.Json.JsonConvert.DeserializeObject<Newtonsoft.Json.Linq.JArray>(MAKT);
	
	//数组类型初始化 
	SPRAS = new String[jsonMAKT.Count];
	MAKTX = new String[jsonMAKT.Count];
	
	//赋值
	for(var i = 0; i<jsonMAKT.Count; i++)
	{
		if(jsonMAKT[i]["SPRAS"] != null)
		{
			SPRAS[i] = jsonMAKT[i]["SPRAS"].ToString();
		}
		else
		{
			SPRAS[i] = "";
		}
		
		if(jsonMAKT[i]["MAKTX"] != null)
		{
			MAKTX[i] = jsonMAKT[i]["MAKTX"].ToString();
		}
		else
		{
			MAKTX[i] = "";
		}
	}
}

```





### 4、String类型与int类型的互相转换

```java
//string 转 int
int a = 0; 
str  =json.DELIVERDETAIL[i].POSNR;
int.TryParse(str,out a);

//int 转 string

```



### 5、声明list集合，再转Array数组

```java
//关重件信息
var keyaccessorys = newObj.reported.keyaccessoryList;
var materialNos = new List<String>();
var materialSerialNOs = new List<String>();
	if(keyaccessorys!= null){
		for(var i =0;i<keyaccessorys.Count;i++){
			materialNos.Add((String)keyaccessorys[i].MaterialNo);
			materialSerialNOs.Add((String)keyaccessorys[i].MaterialSerialNo);
		}
	}
//System.String[] str=listS.ToArray();
MaterialNo = materialNos.ToArray();
MaterialSerialNo = materialSerialNOs.ToArray();
```



### 6、多层JSON复杂拼接序列化（所有字段需相同数组长度）

```java
//准备task List参数列表 JsonArray对象
List<Object> taskData = new List<Object>();
//准备Group List参数列表 JsonArray对象
List<Object> GroupData = new List<Object>();
//准备Component List参数列表 JsonArray对象
List<Object> ComponentData = new List<Object>();

if(AreaNo!=null){
    string iAreaNo = AreaNo[0];
    string iProductType = ProductType[0];
    string iProductNo = ProductNo[0];
    string iGroupNo = GroupNo[0];
	 for(int i=0;i<AreaNo.Length;){
	if(iAreaNo.Equals(AreaNo[i])&&iProductType.Equals(ProductType[i])&&iProductNo.Equals(ProductNo[i])&&iGroupNo.Equals(GroupNo[i])){
			//零件列表部分
            Object Component = new {
                //单个零件重量
                Weight = Weight[i],
                //单台套零件数量
                SingleQTY = SingleQTY[i],
                //单台套零件重量
                SingleWeight = SingleWeight[i],
                //料框总重
                ContainerWeight = ContainerWeight[i],
                //叠放层次
                MAXLevel = MAXLevel[i],
                //零件编号
                ComponentNo = ComponentNo[i],
                //零件名称
                ComponentName = ComponentName[i],
                //备注
                Remark = "",
                //是否为中小件
                IsMedium = ("0".Equals(IsMedium[i])?true:false),
                //是否为折弯件
                IsBend = ("0".Equals(IsBend[i])?true:false),
                //预留参数1
                paramRsrv1 = "",
                //预留参数2
                paramRsrv2 = ""
            };
			 ComponentData.Add(Component);
			i++;
            if(i==AreaNo.Length){
                 var Group = new {
                    //投料组号
                    GroupNo = GroupNo[i-1],
                    //料框类型代号
                    ContainerType = ContainerType[i-1],
                    //部件
                    GroupDesc = GroupDesc[i-1],
                    //单个料框内物料台套数
                    MaxQTY = MaxQTY[i-1],
                    //平均配送频率
                    Frequency = Frequency[i-1],
                    //投料顺序
                    orderNo = OrderNo[i-1],
                    //是否机器人抓取
                    IsAutomatic = false,
                    //预留参数1
                    paramRsrv1 = "",
                    //预留参数2
                    paramRsrv2 = "",
                    //零件列表
                    ComponentList = ComponentData
                };
                GroupData.Add(Group);
				 var task = new {
                //工厂编号
                Facility = Facility[i-1],
                //产线
                ProductionLine = ProductionLine[i-1],
                //工作中心
                WorkCenter = WorkCenter[i-1],
                //主数据版本
                PackDataVersion = PackDataVersion,
                //区域编号
                AreaNo = AreaNo[i-1],
                //泵车型号
                ProductType = ProductType[i-1],
                //结构件编号
                ProductNo = ProductNo[i-1],
                //结构件名称
                ProductName = ProductName[i-1],
                //预留参数1
                paramRsrv1 = "",
                //预留参数2
                paramRsrv2 = "",
                //投料组列表
                GroupList = GroupData
            };
            taskData.Add(task);
            }
	}
	else if(iAreaNo.Equals(AreaNo[i])&&iProductType.Equals(ProductType[i])&&iProductNo.Equals(ProductNo[i])){
		var Group = new {
                    //投料组号
                    GroupNo = GroupNo[i-1],
                    //料框类型代号
                    ContainerType = ContainerType[i-1],
                    //部件
                    GroupDesc = GroupDesc[i-1],
                    //单个料框内物料台套数
                    MaxQTY = MaxQTY[i-1],
                    //平均配送频率
                    Frequency = Frequency[i-1],
                    //投料顺序
                    orderNo = OrderNo[i-1],
                    //是否机器人抓取
                    IsAutomatic = "",
                    //预留参数1
                    paramRsrv1 = "",
                    //预留参数2
                    paramRsrv2 = "",
                    //零件列表
                    ComponentList = ComponentData
                };
		 GroupData.Add(Group);
        //新建Component JsonArray对象
        ComponentData = new List<Object>();
        i++;
		if(i==AreaNo.Length){
            var task = new {
               //工厂编号
                Facility = Facility[i-1],
                //产线
                ProductionLine = ProductionLine[i-1],
                //工作中心
                WorkCenter = WorkCenter[i-1],
                //主数据版本
                PackDataVersion = PackDataVersion,
                //区域编号
                AreaNo = AreaNo[i-1],
                //泵车型号
                ProductType = ProductType[i-1],
                //结构件编号
                ProductNo = ProductNo[i-1],
                //结构件名称
                ProductName = ProductName[i-1],
                //预留参数1
                paramRsrv1 = "",
                //预留参数2
                paramRsrv2 = "",
                //投料组列表
                GroupList = GroupData
            };
            taskData.Add(task);
			//新建GroupData JsonArray对象
			GroupData = new List<Object>();
            //更新值
            iAreaNo = AreaNo[i];
    		iProductType = ProductType[i];
    		iProductNo = ProductNo[i];
    		iGroupNo = GroupNo[i];
        }
	
	}else{
		 var task = new {
                //工厂编号
                Facility = Facility[i-1],
                //产线
                ProductionLine = ProductionLine[i-1],
                //工作中心
                WorkCenter = WorkCenter[i-1],
                //主数据版本
                PackDataVersion = PackDataVersion,
                //区域编号
                AreaNo = AreaNo[i-1],
                //泵车型号
                ProductType = ProductType[i-1],
                //结构件编号
                ProductNo = ProductNo[i-1],
                //结构件名称
                ProductName = ProductName[i-1],
                //预留参数1
                paramRsrv1 = "",
                //预留参数2
                paramRsrv2 = "",
                //投料组列表
                GroupList = GroupData
            };
            taskData.Add(task);
            //新建Group JsonArray对象
            GroupData = new List<Object>();
            //更新值
            iAreaNo = AreaNo[i];
    		iProductType = ProductType[i];
    		iProductNo = ProductNo[i];
    		iGroupNo = GroupNo[i];
	}
	}
	 //序列化JsonParam
    JsonParam = Newtonsoft.Json.JsonConvert.SerializeObject
	(
		new{
			//协议版本
			version = version,
			//消息ID
			taskId = taskId,
			//接口类型
			taskType = taskType,
			//消息内容
			task = taskData
		}
	);
}
```

### 7、获取32位UUID

```java
System.Guid.NewGuid().ToString().Replace("-",""),
```



## 二、Apriso系统报错

### 1、出现”无法绑定null值“

检查外部输入与输出，看是否在删除多余的外部输出时，系统没有进行刷新

### 2、”文本中没有Newtonsoft.....的应用“

检查是否勾线了**”脚本扩展“**





## 三、推送报文格式

### 1、IOT发送给MOM报文统一格式

```Java
{
    "Inputs":{
        "IotJson":"{ \"reported\": [{ \"reqId\": \"W202BHS20ZXB03871\", \"reqSys\": \"CCS\", \"Facility\": \"1820\", \"WipOrderNo\": \"W202B22020110201\", \"SequenceNo\": \"000000\", \"OprSequenceNo\": \"1820-512021\", \"WorkStation\": \"1820WJ02A0010\", \"ActualStartDate\": \"2020/11/2 20:31:01\", \"ActualCompleteDate\": \"\", \"DeviceID\": \"\", \"ProgressType\": \"0\", \"ProductNo\": \"11350803\", \"SerialNo\": \"W202BHS20ZXB03871\", \"EmployeeNo\": \"\", \"keyaccessoryList\": null }], \"version\": 1, \"taskId\": \"998277ff-7816-4a95-b013-8f7f12fdccae\", \"taskType\": \"3\" }"
    }
}
```



## 四、对于JsonList对象数组的拼接方式

```java
ReturnJsonData = "{\"RT_RESP\"\:" +"["+ReturnList + "]"+"}"
 //ReturnList里有多个json对象
"{"test":"1"}" "{"test1":"2"}"
 //执行后
 {"RT_RESP":[{"test":"1"},{"test1":"2"}]}
```



## 五、对于多个元素的组合，去重方式

1. 将值进行序列化，拼成json字符串，然后再放入HashSet中，进行自动去重

   ```java
   //声明set集合，去除重复的数据
   HashSet<string> set = new HashSet<string>();
   for(var i = 0;i<AreaNo.Count();i++)
   {
   	string json =  Newtonsoft.Json.JsonConvert.SerializeObject(
   			new{
   				AreaNo = AreaNo[i],
   				ProductNo = ProductNo[i],
   				ProductType = ProductType[i],
   				ProductName = ProductName[i]
   			}
   		);
   	set.Add(json);
   }
   
   List<string> Json = new List<string>();
   Json = set.ToList();
   
   List<string> iAr = new List<string>();
   List<string> iPr = new List<string>();
   List<string> iPt = new List<string>();
   List<string> iPn = new List<string>();
   for(var j = 0;j<Json.Count();j++)
   {
   	//反序列化子json对象
   	dynamic newObj = JsonConvert.DeserializeObject(Json[j]);
   	iAr.Add((string)newObj.AreaNo);
   	iPr.Add((string)newObj.ProductNo);
   	iPt.Add((string)newObj.ProductType);
   	iPn.Add((string)newObj.ProductName);
   }
   
   iAreaNo = iAr.ToArray();
   iProductNo = iPr.ToArray();
   iProductType = iPt.ToArray();
   iProductName = iPn.ToArray();
   ```

   



## 六、SQL的拼接方式

```java
SELECT 
    ID 
FROM 
    ILT_COMPLETE_WIPORDER_MQ
WHERE 1 = 1
{SQLSENTENCE}
//将拼接的SQL条件通过参数的形式进行传入，即可对其进行特定的赋值
SQLSENTENCE = AND WIPORDERNO LIKE "'"+@FACILITY+"%"+"'"-------模糊查询
```

## 七、四舍五入的运算，及小数位保留

```java
/**
* 实际加注量四舍五入处理，与SAP保持一致
*/
oQuantityList = new Decimal[QuantityList.Length];
//保留三位小数
int decision=3;

for(int i=0;i<QuantityList.Length;i++){
	oQuantityList[i] = System.Decimal.Round(QuantityList[i], decision);
}
```



## 八、时间格式转换string并截取“年月日”，时间戳

```java
//将时间格式转换成string格式数据
string iEEIND = Convert.ToString(EEIND);
//DateTime.Parse(iEEIND)括号中放的只能是string类型的数据
iEEIND = DateTime.Parse(iEEIND).ToString("yyyyMMdd");
string iBADAT = Convert.ToString(BADAT);
iBADAT = DateTime.Parse(iBADAT).ToString("yyyyMMdd");
//获取时间戳
//获取当前系统时间
DateTime time = DateTime.Now;
//DateTime time =new DateTime(2020,12,24,7,10,0,0);
TimeSpan ts  = time - new DateTime(1970,1,1,0,0,0,0);
//取当前系统时间戳-string
TS = Convert.ToInt64(ts.TotalSeconds).ToString();

string date = time.ToString("yyyy-MM-ddHHmmss");
string hour= date.Substring(10,2);
int IntHour = int.Parse(hour);
/**
* 数据库存得是UTC时间，所以时间需要减8小时去比较
* （当天8:00到当前时间每小时的生产数量）
* 如果大于8小时，则是属于当天，小于8小时，属于昨天
*/
if(IntHour>=8){
	StartTime = date.Substring(0,10)+" 00:00:00";
	EndTime = date.Substring(0,10)+" "+(IntHour-8)+":59:59";
}else{
	string yDate = DateTime.Now.AddDays(-1).ToString("yyyy-MM-ddHHmmss");
	StartTime = yDate.Substring(0,10)+" 00:00:00";
	EndTime = yDate.Substring(0,10)+" "+(IntHour+24-8)+":59:59";
}
//StartTime = hour;
```

## 九、对于XML格式的报文

#### 报文的拼接

```java
/*var bpmUser = String.Empty;
var bpmPassword = String.Empty;
	
if(false == String.IsNullOrEmpty(BpmAccount)){
	
	//BPM的登录账号密码放在一块,有/ 分割
	var accountInfos = BpmAccount.Split("\\;,/".ToCharArray(),StringSplitOptions.RemoveEmptyEntries);
	bpmUser = accountInfos[0];
	if(accountInfos.Length > 0){
		bpmPassword = accountInfos[1];
	}
}*/


	var bpmUser = user;
	var bpmPassword = password;
	//var flowParam = "{'auditNode':'调整后重新提交，请领导批准!'}";
	var flowParam = Newtonsoft.Json.JsonConvert.SerializeObject( new {
		auditNode = "调整后重新提交，请领导批准!"
	});
	//var idocCreator = "{'LoginName':'"+docCreator+"'}";
	var idocCreator = Newtonsoft.Json.JsonConvert.SerializeObject( new {
		LoginName = docCreator
	});
	
	
	var ms = new System.IO.MemoryStream(1024);//分配空间
	System.Xml.XmlTextWriter Xmltr = new System.Xml.XmlTextWriter(ms, System.Text.Encoding.UTF8);

	//var userInfo = new { LoginName = DocCreator };
	
	var tnsVal = "http://webservice.review.km.kmss.landray.com/";
			
	// FILE HEADER
     Xmltr.WriteStartElement("soapenv", "Envelope", "http://schemas.xmlsoap.org/soap/envelope/");
     Xmltr.WriteAttributeString("xmlns", "web", null, "http://webservice.review.km.kmss.landray.com/");
	
	//---HEADER
     Xmltr.WriteStartElement("Header", "http://schemas.xmlsoap.org/soap/envelope/");        
     Xmltr.WriteStartElement("tns", "RequestSOAPHeader", tnsVal);
     Xmltr.WriteElementString("user", tnsVal, bpmUser );
     Xmltr.WriteElementString("password", tnsVal, bpmPassword);
     Xmltr.WriteEndElement();
     Xmltr.WriteEndElement();
	
	// BODY
     Xmltr.WriteStartElement("Body", "http://schemas.xmlsoap.org/soap/envelope/");
     Xmltr.WriteStartElement("web", "approveProcess",null);
	 Xmltr.WriteStartElement("arg0", null);
	 Xmltr.WriteElementString("attachmentInfo",attachmentInfo);
	 Xmltr.WriteElementString("auditNote",auditNote);
     Xmltr.WriteElementString("docContent",null);
	 Xmltr.WriteElementString("docCreator",idocCreator);
	 Xmltr.WriteElementString("docSubject",docSubject);
	 Xmltr.WriteElementString("fdId",fdId);
	 Xmltr.WriteElementString("fdKeyword",null);
	 Xmltr.WriteElementString("flowParam",flowParam);
	 Xmltr.WriteElementString("formValues",formValues);
    

	///BPM 相关的属性
	//Xmltr.WriteElementString("auditNote", AuditNote);
    //Xmltr.WriteElementString("docCreator", Newtonsoft.Json.JsonConvert.SerializeObject(userInfo));  
   
	Xmltr.WriteEndElement(); //end arg
	Xmltr.WriteEndElement(); //end web
	Xmltr.WriteEndElement(); // end body
    Xmltr.WriteEndElement();  //end soap

	Xmltr.Flush();
    Xmltr.Close();
    xmlContent =  System.Text.Encoding.UTF8.GetString(ms.GetBuffer());

```

#### 返回报文处理

```java
oContent = Content;
HasError = false;
try {
    XmlTextReader xr = new XmlTextReader(new System.IO.StringReader(Content));
    while(xr.Read()) {
        if(xr.NodeType == XmlNodeType.Element) {
            if(xr.Name.Contains("faultcode")) {
                ErrorCode = xr.ReadElementContentAsString(); 
				HasError = true;
            }
			if(xr.Name.Contains("faultstring")) {
                ErrorMsg = xr.ReadElementContentAsString();
				HasError = true;
            }
            if(xr.Name.Contains("docUrl")) {
                DocURL = xr.ReadElementContentAsString();
            }
            if(xr.Name.Contains("return")) {
                FDID = xr.ReadElementContentAsString(); 
            }           
        }
    }
} catch(System.Exception e) {
	HasError = true;
	ErrorMsg = e.Message;
}
```

